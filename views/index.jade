extends layout
block content
  .container
    h2#error.alert-danger.text-center
    input#cityName.form-control.input-lg.text-center(type='text', placeholder='Enter a Major City Name (i.e. Austin)')
    br
    p#get-weather
      a.btn.btn-lg.btn-success.btn-block(href='#', role='button') Get Weather
  .container.main
    .jumbotron
      .row
        .col-md-7
          h1#cityNameBanner
          canvas#icon1(width='128', height='128')
          .weather-forecast
            .day
              h3 Today
              dl.day.dl-horizontal
                dt Humidity:
                dd#humidity
                dt Pressure:
                dd#pressure
                dt Temperature:
                dd#temperature
                dt High:
                dd#high
                dt Low:
                dd#low
        .col-md-5
          h2 Comments
          form#comment-form
            ul#comment-list
              li.comment A comment
            input.form-control#comment-box(rows="2")
            button.btn.btn-primary(type="submit") Post
  .container
        //- fieldset
        //-   input#cityName(type='text', placeholder='City name')
        //- p#get-weather
        //-   a.btn.btn-lg.btn-success(href='#', role='button') Get Weather
    script(src='http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js')
    script(src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js')
    script(src='http://learn.themakersquare.com/materials/vendor/jquery.riot.js')
    script(src='http://learn.themakersquare.com/materials/week-7/weather-icons.js')
    script(src='/javascripts/global.js')
    script(src='/javascripts/client.js')
    script.
      $(function($) {
        var socket = io.connect();

        var $commentForm = $('#comment-form');
        var $commentBox = $('#comment-box');
        var $commentList = $('#comment-list');

        // Initialize skycons
        var skycons = new Skycons({"color": "black"});

        // Sets weather button to variable
        var $weatherButton = $('#get-weather');

        $weatherButton.on('click', function(e) {
          e.preventDefault;
          console.log('Fetching weather...');
          // Grab city name string from input field
          $cityName = $('#cityName').val();
          // clear error messages if any
          $('#error').hide();
          // Fade out main display so it can fade back in
          $('.container.main').fadeOut(200);

          $.ajax({
            url: "http://api.openweathermap.org/data/2.5/weather?q=" + $cityName + "&mode=json&units=imperial",
            type: "get",
            dataType: "json",
            success: function (data) {
              console.log(data.cod);
              // Only show results if what is typed in city name
              // input is valid
              if (data.cod === 200) {
                console.log(data.cod);

                // store city name in array
                socket.emit('send city name', $cityName, function(data) {
                  if (data) {
                    // show comments for this city
                    console.log('hooray');
                  } else {
                    // gather weather info for city and display
                    // as well as allow new comments to be added
                    console.log("already there");
                  }
                });

                $('#cityNameBanner').text($cityName + " Weather");
                $('.container.main').fadeIn(200);
                // Update named fields with API weather data for specific city
                $('#humidity').text(data.main.humidity + "%");
                $('#pressure').text(data.main.pressure);
                $('#temperature').text(data.main.temp);
                $('#high').text(data.main.temp_max);
                $('#low').text(data.main.temp_min);

                // Clear city weather input value
                $('#cityName').val('');

                // Display weather condition info reported from API JSON
                var weatherCondition = data.weather[0].main
                console.log(weatherCondition);

                // Display appropriate Skycon based on current weather.
                // May not always work--unsure of all
                // possible weather descriptions at the moment
                if (weatherCondition.indexOf("Rain") != -1) {
                  skycons.add("icon1", Skycons.RAIN);
                } else if (weatherCondition.indexOf("Clear") != -1) {
                  skycons.add("icon1", Skycons.CLEAR_DAY);
                } else if (weatherCondition.indexOf("Wind") != -1) {
                  skycons.add("icon1", Skycons.WIND);
                } else if (weatherCondition.indexOf("Fog") != -1) {
                  skycons.add("icon1", Skycons.FOG);
                } else if (weatherCondition.indexOf("Clouds") != -1) {
                  skycons.add("icon1", Skycons.CLOUDY);
                } else if (weatherCondition.indexOf("Snow") != -1) {
                  skycons.add("icon1", Skycons.SNOW);
                } else if (weatherCondition.indexOf("Mist") != -1) {
                  skycons.add("icon1", Skycons.FOG);
                }

                // Animate Skycons
                skycons.play();
              } else {
                // Return what was typed into city name input
                console.log("Sorry, please enter a city");
                $('#error').fadeIn(200).html("Sorry, " + $cityName + " is either not a city or is spelled incorrectly.");
                $('#cityName').val('');
              }
            },
            error: function(xhr, status) {
              // In case there's an error on the API side
              console.log("There was an error");
              $('#error').fadeIn(200).html("There was an error, please try again later");
            }
          });
         });

        $commentForm.submit(function(e) {
          e.preventDefault;
          socket.emit('create comment', $commentBox.val());
          $commentBox.val('');
        });

        socket.on('new comment', function(data) {
          $cityName = $('#city-name').val();
          $commentList.append("<li class='comment'>" + data + "</li>");
        });
      });
